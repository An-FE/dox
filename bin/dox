#!/usr/bin/env node

/**
 * Module dependencies.
 */

var dox = require('../')
  , util = require('util')
  , fs = require('fs');

/**
 * Arguments.
 */

var args = process.argv.slice(2);

/**
 * Debug.
 */

var debug = false;

/**
 * Verbose.
 */

var verbose = false;

/**
 * File map
 */

var files = {};

/**
 * File paths to parse.
 */

var paths = [];

/**
 * Doc template.
 */

var template = 'default';

/**
 * Usage information.
 */

var usage = [
    ''
  , '  Usage: dox [options] <paths>'
  , ''
  , '  Options:'
  , ''
  , '    -t, --template <name>  use the given template <name>'
  , '    -D, --debug            output parsed comments for debugging'
  , '    -v, --verbose          enable verbose output'
  , '    -h, --help             display help information'
  , ''
].join('\n');

/**
 * Required argument.
 */

function required(arg) {
  if (args.length) {
    return args.shift();
  } else {
    console.error(arg + ' requires an argument');
    process.exit(1);
  }
}

// parse arguments

var arg;
while (args.length) {
  switch (arg = args.shift()) {
    case '-h':
    case '--help':
      console.log(usage);
      process.exit(0);
      break;
    case '-D':
    case '--debug':
      debug = true;
      break;
    case '-v':
    case '--verbose':
      verbose = true;
      break;
    case '-t':
    case '--template':
      template = required(arg);
      break;
    default:
      paths.push(arg);
  }
}

/**
 * Log `msg` when verbose.
 */

function log(key, msg) {
  if (!verbose) return;
  console.log('  \033[90m%s :\033[0m \033[36m%s\033[0m', key, msg);
}

// ensure files

if (!paths.length) {
  console.error('<paths> required');
  process.exit(1);
}

// parse input

var pending = paths.length;
paths.forEach(function(path){
  fs.readFile(path, 'utf8', function(err, str){
    if (err) throw err;
    log('parse', path);
    files[path] = dox.parseComments(str);
    if (debug) {
      console.log(util.inspect(files[path], false, 15, true));
      console.log();
    }
  });
});
